<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" id="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <title>Rapid Auth</title>
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-auth.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
</head>

<body>
    <div style="height: 76vh; display: table;width: 100%; text-align:center;margin-top: 93px;" id="signup-form">
        <h3 style="font-family:Roboto-Regular,serif;font-size: 24px;">Sign Up To Rapid</h3>
        <div style="display: table-row">
            <div style="display: table-cell; vertical-align: middle;">
                <label class="mdc-text-field mdc-text-field--outlined name-field" style="width: 60vh;">
  <span class="mdc-notched-outline">
    <span class="mdc-notched-outline__leading"></span>
    <span class="mdc-notched-outline__notch">
      <span class="mdc-floating-label" id="name-label">Name</span>
    </span>
    <span class="mdc-notched-outline__trailing"></span>
  </span>
  <input required type="text" class="mdc-text-field__input" id="name-input" aria-labelledby="my-label-id">
</label>
            </div>
        </div>
        <div style="display: table-row">
            <div style="display: table-cell; vertical-align: middle;">
                <label class="mdc-text-field mdc-text-field--outlined email-field" style="width: 60vh;">
  <span class="mdc-notched-outline">
    <span class="mdc-notched-outline__leading"></span>
    <span class="mdc-notched-outline__notch">
      <span class="mdc-floating-label" id="email-label">Email</span>
    </span>
    <span class="mdc-notched-outline__trailing"></span>
  </span>
    <input required type="email" class="mdc-text-field__input" id="email-input" aria-labelledby="my-label-id">
  </label>
            </div>
        </div>
        <div style="display: table-row">
            <div style="display: table-cell; vertical-align: middle;">
                <label class="mdc-text-field mdc-text-field--outlined password-field" style="width: 60vh;">
          <span class="mdc-notched-outline">
            <span class="mdc-notched-outline__leading"></span>
            <span class="mdc-notched-outline__notch">
              <span class="mdc-floating-label" id="password-label">Password</span>
            </span>
            <span class="mdc-notched-outline__trailing"></span>
          </span>
          <input minlength="6" required type="password" class="mdc-text-field__input" id="password-input" aria-labelledby="my-label-id">
        </label>
            </div>
        </div>
        <button disabled class="mdc-button mdc-button--raised" style="width: 192px;" id="signup-btn">
    <div class="mdc-button__ripple"></div>
    <span class="mdc-button__label">Sign Up</span>
  </button>
        <p style="font-family: Roboto-Regular,serif;">Already have an account?</p>
        <u style="font-family: Roboto-Regular,serif;cursor: pointer;" id="alreadyhaveanaccount">Sign In</u>
    </div>
    <div style="height: 62vh;width: 100%; text-align:center;margin-top: 130px; display: none;" id="signin-form">
        <h3 style="font-family:Roboto-Regular,serif;font-size: 24px;">Sign In To Rapid</h3>
        <div style="display: table-row">
            <div style="display: table-cell; vertical-align: middle;">
                <label class="mdc-text-field mdc-text-field--outlined signin-email-field" style="width: 60vh;">
  <span class="mdc-notched-outline">
    <span class="mdc-notched-outline__leading"></span>
    <span class="mdc-notched-outline__notch">
      <span class="mdc-floating-label" id="signin-email-label">Email</span>
    </span>
    <span class="mdc-notched-outline__trailing"></span>
  </span>
        <input required type="email" class="mdc-text-field__input" id="signin-email-input" aria-labelledby="my-label-id">
      </label>
            </div>
        </div>
        <div style="display: table-row">
            <div style="display: table-cell; vertical-align: middle;">
                <label class="mdc-text-field mdc-text-field--outlined signin-password-field" style="width: 60vh;">
  <span class="mdc-notched-outline">
    <span class="mdc-notched-outline__leading"></span>
    <span class="mdc-notched-outline__notch">
      <span class="mdc-floating-label" id="signin-password-label">Password</span>
    </span>
    <span class="mdc-notched-outline__trailing"></span>
  </span>
        <input minlength="6" required type="password" class="mdc-text-field__input" id="signin-password-input" aria-labelledby="my-label-id">
      </label>
            </div>
        </div>
        <button disabled class="mdc-button mdc-button--raised" style="width: 192px;" id="signin-btn">
    <div class="mdc-button__ripple"></div>
    <span class="mdc-button__label">Sign In</span>
  </button>
        <p style="font-family: Roboto-Regular,serif;">Don't have an account?</p>
        <u style="font-family: Roboto-Regular,serif;cursor: pointer;" id="donthaveanaccount">Sign Up</u>
    </div>
    <div class="mdc-snackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
                Error
            </div>
        </div>
    </div>
    <script>
        // Global boolean variable that holds the current orientation
        var pageInPortraitMode;

        // Listen for window resizes to detect orientation changes
        window.addEventListener("resize", windowSizeChanged);

        // Set the global orientation variable as soon as the page loads
        addEventListener("load", function() {
            pageInPortraitMode = window.innerHeight > window.innerWidth;
            document.getElementById("viewport").setAttribute("content", "width=" + window.innerWidth + ", height=" + window.innerHeight + ", initial-scale=1.0, maximum-scale=1.0, user-scalable=0");
        })

        // Adjust viewport values only if orientation has changed (not on every window resize)
        function windowSizeChanged() {
            if (((pageInPortraitMode === true) && (window.innerHeight < window.innerWidth)) || ((pageInPortraitMode === false) && (window.innerHeight > window.innerWidth))) {
                pageInPortraitMode = window.innerHeight > window.innerWidth;
                document.getElementById("viewport").setAttribute("content", "width=" + window.innerWidth + ", height=" + window.innerHeight + ", initial-scale=1.0, maximum-scale=1.0, user-scalable=0");
            }
        }
        const API_SERVER_URL = "http://localhost:9980";
        let isSigningUp = false;
        const firebaseConfig = {
            apiKey: "AIzaSyCPEQpKKzAxKREl7enSSSSWTc5UG3DftBc",
            authDomain: "aixbuilder.firebaseapp.com",
            projectId: "aixbuilder",
            storageBucket: "aixbuilder.appspot.com",
            messagingSenderId: "964934130307",
            appId: "1:964934130307:web:73fcb8e2382f76cb4659b6",
            measurementId: "G-8Q89DSMK8F"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const PATH_TO_BUILDER = "../client/index.html";
        console.log(firebase.auth().currentUser);
        firebase.auth().onAuthStateChanged(function(user) {
            console.log(user);
            if (user && !isSigningUp) {
                location.replace(PATH_TO_BUILDER);
            }
        });
        new mdc.textField.MDCTextField(document.querySelector('.email-field'));
        new mdc.textField.MDCTextField(document.querySelector('.name-field'));
        new mdc.textField.MDCTextField(document.querySelector('.password-field'));
        new mdc.textField.MDCTextField(document.querySelector('.signin-email-field'));
        new mdc.textField.MDCTextField(document.querySelector('.signin-password-field'));
        document.querySelectorAll('.mdc-button').forEach(
            function(ele) {
                mdc.ripple.MDCRipple.attachTo(ele);
            });
        document.getElementById("alreadyhaveanaccount").addEventListener("click", function() {
            document.getElementById("signin-form").style.display = 'table';
            document.getElementById("signup-form").style.display = 'none';
        });
        document.getElementById("donthaveanaccount").addEventListener("click", function() {
            document.getElementById("signup-form").style.display = 'table';
            document.getElementById("signin-form").style.display = 'none';
        });
        document.getElementById("signup-btn").addEventListener("click", function() {
            isSigningUp = true;
            firebase.auth().createUserWithEmailAndPassword(document.getElementById("email-input").value,
                    document.getElementById("password-input").value)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    user.updateProfile({
                        displayName: document.getElementById("name-input").value,
                        photoURL: "https://ui-avatars.com/api/?name=" + document.getElementById("name-input").value + "&rounded=true"
                    }).then(() => {
                        const xhr = new XMLHttpRequest();
                        xhr.open("POST", API_SERVER_URL + "/user", true);
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.onreadystatechange = function() {
                            console.log(xhr.responseText);
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                location.replace(PATH_TO_BUILDER);
                            } else if (xhr.status !== 200) {
                                const snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'));
                                snackbar.labelText = xhr.responseText;
                                snackbar.open();
                            }
                        }
                        xhr.send(JSON.stringify({
                            uid: user.uid,
                            name: user.displayName,
                            email: user.email,
                            photoUrl: user.photoURL}));
                    }).catch((error) => {
                        const errorMessage = error.message;
                        const snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'));
                        snackbar.labelText = errorMessage;
                        snackbar.open();
                    });
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    const snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'));
                    snackbar.labelText = errorMessage;
                    snackbar.open();
                });
        });
        function escape (key, val) {
            if (typeof(val)!="string") return val;
            return val
                .replace(/[\\]/g, '\\\\')
                .replace(/[\/]/g, '\\/')
                .replace(/[\b]/g, '\\b')
                .replace(/[\f]/g, '\\f')
                .replace(/[\n]/g, '\\n')
                .replace(/[\r]/g, '\\r')
                .replace(/[\t]/g, '\\t')
                .replace(/[\"]/g, '\\"')
                .replace(/\\'/g, "\\'")
                .replaceAll('\n', '\\n');
        }
        document.getElementById("signin-btn").addEventListener("click", function() {
            firebase.auth().signInWithEmailAndPassword(document.getElementById("signin-email-input").value,
                    document.getElementById("signin-password-input").value)
                .then(() => {
                    // handled by onAuthStateChanged method
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    const snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'));
                    snackbar.labelText = errorMessage;
                    snackbar.open();
                });
        });
        const nameInput = document.getElementById("name-input");
        const signup = document.getElementById("signup-btn");
        nameInput.addEventListener("input", function() {
            if (!isAllInputsValid()) {
                signup.setAttribute("disabled", "disabled");
            } else {
                signup.removeAttribute("disabled");
            }
        });
        const emailInput = document.getElementById("email-input");
        emailInput.addEventListener("input", function() {
            if (!isAllInputsValid()) {
                signup.setAttribute("disabled", "disabled");
            } else {
                signup.removeAttribute("disabled");
            }
        });
        const passwordInput = document.getElementById("password-input");
        passwordInput.addEventListener("input", function() {
            if (!isAllInputsValid()) {
                signup.setAttribute("disabled", "disabled");
            } else {
                signup.removeAttribute("disabled");
            }
        });
        const signinEmailInput = document.getElementById("signin-email-input");
        const signin = document.getElementById("signin-btn");
        signinEmailInput.addEventListener("input", function() {
            if (!isAllSigninInputsValid()) {
                signin.setAttribute("disabled", "disabled");
            } else {
                signin.removeAttribute("disabled");
            }
        });
        const signInPasswordInput = document.getElementById("signin-password-input");
        signInPasswordInput.addEventListener("input", function() {
            if (!isAllSigninInputsValid()) {
                signin.setAttribute("disabled", "disabled");
            } else {
                signin.removeAttribute("disabled");
            }
        });

        function isAllInputsValid() {
            return emailInput.value.length !== 0 && /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(emailInput.value) && nameInput.value.length !== 0 && passwordInput.value.length > 6;
        }

        function isAllSigninInputsValid() {
            return signinEmailInput.value.length !== 0 && /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(signinEmailInput.value) && signInPasswordInput.value.length > 6;
        }
    </script>
</body>

</html>